---
apiVersion: v1
kind: Namespace
metadata:
  name: JENKINS_NAMESPACE
  labels:
    app.kubernetes.io/name: bedetheque-scraper
    app.kubernetes.io/part-of: comix
    app.kubernetes.io/managed-by: jenkins
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: JENKINS_NAMESPACE
  name: bedetheque-scraper
  labels:
    app.kubernetes.io/name: bedetheque-scraper
    app.kubernetes.io/instance: bedetheque-scraper-abcxyz
    app.kubernetes.io/version: "JENKINS_BUILD_NUMBER"
    app.kubernetes.io/component: server
    app.kubernetes.io/part-of: comix
    app.kubernetes.io/managed-by: jenkins
    env: JENKINS_COMIX_ENV
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: bedetheque-scraper
      app.kubernetes.io/component: server
      app.kubernetes.io/part-of: comix
      app.kubernetes.io/managed-by: jenkins
      env: JENKINS_COMIX_ENV
  template:
    metadata:
      labels:
        app.kubernetes.io/name: bedetheque-scraper
        app.kubernetes.io/version: "JENKINS_BUILD_NUMBER"
        app.kubernetes.io/component: server
        app.kubernetes.io/part-of: comix
        app.kubernetes.io/managed-by: jenkins
        env: JENKINS_COMIX_ENV
    spec:
      containers:
        - name: bedetheque-scraper
          image: NEXUS_DOCKER_REPOSITORY/comix-bedetheque-scraper-POM_VERSION:JENKINS_BUILD_NUMBER
          imagePullPolicy: Always
          command:
            - "java"
          args:
            - "-jar"
            - "/opt/app/app.jar"
          resources:
            limits:
              cpu: "2"
              memory: 2Gi
            requests:
              cpu: 500m
              memory: 1Gi
          ports:
            - containerPort: JENKINS_COMIX_BEDETHEQUE_SCRAPER_PORT
          envFrom:
            - configMapRef:
                name: bedetheque-scraper-config
      imagePullSecrets:
        - name: nexus-docker
---
apiVersion: v1
kind: Service
metadata:
  namespace: JENKINS_NAMESPACE
  name: bedetheque-scraper-nodeport
  labels:
    app.kubernetes.io/name: bedetheque-scraper-service
    app.kubernetes.io/instance: bedetheque-scraper-service-abcxyz
    app.kubernetes.io/version: "JENKINS_BUILD_NUMBER"
    app.kubernetes.io/component: service
    app.kubernetes.io/part-of: comix
    app.kubernetes.io/managed-by: jenkins
    env: JENKINS_COMIX_ENV
spec:
  type: NodePort
  ports:
    - port: JENKINS_COMIX_BEDETHEQUE_SCRAPER_PORT
      protocol: TCP
      targetPort: JENKINS_COMIX_BEDETHEQUE_SCRAPER_PORT
      nodePort: JENKINS_COMIX_BEDETHEQUE_SCRAPER_NODEPORT
  selector:
    app.kubernetes.io/name: bedetheque-scraper
    env: JENKINS_COMIX_ENV
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: bedetheque-scraper-config
  namespace: JENKINS_NAMESPACE
  labels:
    app.kubernetes.io/name: bedetheque-scraper-config
    app.kubernetes.io/instance: bedetheque-scraper-config-abcxyz
    app.kubernetes.io/version: "JENKINS_BUILD_NUMBER"
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: comix
    app.kubernetes.io/managed-by: jenkins
    env: JENKINS_COMIX_ENV
data:
  SPRING_PROFILES_ACTIVE: "JENKINS_COMIX_ENV"
  COMIX_CONFIG_SERVER_URL: "JENKINS_COMIX_CONFIG_SERVER_URL"
  COMIX_CONFIG_SERVER_PORT: "JENKINS_COMIX_CONFIG_SERVER_PORT"
  COMIX_BEDETHEQUE_SCRAPER_PORT: "JENKINS_COMIX_BEDETHEQUE_SCRAPER_PORT"
  LOGSTASH_URL: "JENKINS_LOGSTASH_URL"
  LOGSTASH_PORT: "JENKINS_COMIX_LOGSTASH_PORT"